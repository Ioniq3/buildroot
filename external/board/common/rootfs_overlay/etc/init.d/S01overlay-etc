#!/bin/sh

LOWERDIR="/etc"
OVERLAY_BASE="/persist/overlay-etc"
UPPERDIR="$OVERLAY_BASE/upper"
WORKDIR="$OVERLAY_BASE/work"
MERGED="$OVERLAY_BASE/merged"

# creating missing directories for the first time
mkdir -p "$UPPERDIR" "$WORKDIR" "$MERGED"

# copy initial configuration
if [ -z "$(ls -A "$UPPERDIR")" ]; then
    echo "[overlay-etc] Copying original /etc to upperdir..."
    cp -a "$LOWERDIR/." "$UPPERDIR/"
fi

# OverlayFS mount
mount -t overlay overlay -o lowerdir="$LOWERDIR",upperdir="$UPPERDIR",workdir="$WORKDIR" "$MERGED"

# bind-mount new overlayed /etc
mount --bind "$MERGED" /etc
