#!/bin/sh

USERDATA_MOUNT_POINT="/data"

echo "Mounting userdata partition..."
mount $USERDATA_MOUNT_POINT

# Check for factory reset trigger
FACTORY_RESET_FLAG="$USERDATA_MOUNT_POINT/factory-reset"
if [ -f "$FACTORY_RESET_FLAG" ]; then
    echo "Factory reset flag found! Wiping all data in $USERDATA_MOUNT_POINT..."

    # Wipe all content under /data
    find "$USERDATA_MOUNT_POINT" -mindepth 1 -exec rm -rf {} +

    echo "Factory reset complete."
fi

echo "Applying OverlayFS..."
# root directories handled by overlayfs
for DIR in etc var; do
    LOWERDIR="/$DIR"
    UPPERDIR="$USERDATA_MOUNT_POINT/$DIR"
    WORKDIR="$USERDATA_MOUNT_POINT/.$DIR-work"

    # creating missing directories for the first time
    mkdir -p "$UPPERDIR"
    mkdir -p "$WORKDIR"

    # OverlayFS mount
    mount -t overlay overlay -o lowerdir="$LOWERDIR",upperdir="$UPPERDIR",workdir="$WORKDIR" "$LOWERDIR"
done

echo "OverlayFS mounted, starting BusyBox init (/sbin/init)..."
exec /sbin/init
